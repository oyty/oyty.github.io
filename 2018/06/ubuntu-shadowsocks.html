<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="author" content="oyty"/>
    <title>Ubuntu 16.04下Shadowsocks服务器端安装及优化</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="http://oyty.me/feed/" rel="alternate" title="oyty" type="application/atom+xml"/>
    <link rel="stylesheet" href="http://oyty.me/media/css/style.css">
    <link rel="stylesheet" href="http://oyty.me/styles/github.css">
    |
</head>

<div id="top"></div>
<body>
<div id="container">
    <div id="main" role="main">
        <header>
            <h1>Ubuntu 16.04下Shadowsocks服务器端安装及优化</h1>
        </header>

        <nav>
            <span><a title="home page" class="" href="http://oyty.me/">home</a></span>
            <span><a title="about" class="" href="http://oyty.me/about/">about</a></span>
            <span><a title="publication" class="" href="http://oyty.me/publication/">publication</a></span>
            <span><a title="guestbook" class="" href="http://oyty.me/guestbook/">guestbook</a></span>
            <span><a title="vitae" class="" href="http://oyty.me/vitae/">vitae</a></span>
            <span><a title="categories" class="" href="http://oyty.me/category.html">categories</a></span>
            <span><a title="tags" class="" href="http://oyty.me/tags.html">tags</a></span>
            <span><a title="links" class="" href="http://oyty.me/links/">links</a></span>
            <span><a title="subscribe by RSS" class="" href="http://feed.feedsky.com/laimingxing">subscribe</a></span>
        </nav>

        <article class="content">

            <section class="post">
                <!--
title: Ubuntu 16.04下Shadowsocks服务器端安装及优化
time: 2018-06-14
category: 其它
tags: 翻墙, shadowsocks, bbr
-->

<p>﻿#### 前言
本教程旨在提供简明的Ubuntu 16.04下安装服务器端Shadowsocks。不同于Ubuntu 16.04之前的教程，本文抛弃initd，转而使用Ubuntu 16.04支持的Systemd管理Shadowsocks的启动与停止，显得更为便捷。优化部分包括BBR、TCP Fast Open以及吞吐量优化。
本教程仅适用于Ubuntu 16.04及之后的版本，基于Python 3，支持IPv6。</p>

<h4>安装pip</h4>

<p>本教程使用Python 3为载体，因Python 3对应的包管理器pip3并未预装，首先安装pip3：</p>

<pre><code>sudo apt install python3-pip
</code></pre>

<h4>安装Shadowsocks</h4>

<p>因Shadowsocks作者不再维护pip中的Shadowsocks（定格在了2.8.2），我们使用下面的命令来安装最新版的Shadowsocks：</p>

<pre><code>pip3 install https://github.com/shadowsocks/shadowsocks/archive/master.zip
</code></pre>

<p>安装完成后可以使用下面这个命令查看Shadowsocks版本：</p>

<pre><code>sudo ssserver --version
</code></pre>

<p>目前会显示“Shadowsocks 3.0.0”。</p>

<h4>创建配置文件</h4>

<p>创建Shadowsocks配置文件所在文件夹：</p>

<pre><code>sudo mkdir /etc/shadowsocks
</code></pre>

<p>然后创建配置文件：</p>

<pre><code>sudo nano /etc/shadowsocks/config.json
</code></pre>

<p>复制粘贴如下内容（注意修改密码“password”）：</p>

<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">8388</span><span class="p">,</span>
    <span class="nt">&quot;local_address&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">1080</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;mypassword&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;aes-256-cfb&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fast_open&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>

<p>然后按Ctrl + O保存文件，Ctrl + X退出。</p>

<h4>测试Shadowsocks配置</h4>

<p>首先记录下服务器的IP地址</p>

<pre><code>ifconfig
</code></pre>

<p>找到IPv4地址（和IPv6地址），如我的ifconfig输出为</p>

<pre><code>eth0      Link encap:Ethernet  HWaddr 46:91:89:4e:c1:52
          inet addr:138.68.51.55  Bcast:138.68.63.255  Mask:255.255.240.0
          inet6 addr: fe80::4491:89ff:fe4e:c152/64 Scope:Link
          inet6 addr: 2604:a880:2:d0::3727:7001/64 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:102667 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7869 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:151166937 (151.1 MB)  TX bytes:1151476 (1.1 MB)
</code></pre>

<p>所以我的IPv4地址是<code>138.68.51.55</code>，IPv6地址是<code>2604:a880:2:d0::3727:7001</code>。
然后来测试下Shadowsocks能不能正常工作了：</p>

<pre><code>ssserver -c /etc/shadowsocks/config.json
</code></pre>

<p>在Shadowsocks客户端添加服务器，如果你使用的是我提供的那个配置文件的话，地址填写你的IPv4地址或IPv6地址，端口号为8388，加密方法为aes-256-cfb，密码为你设置的密码。然后设置客户端使用全局模式，浏览器登录Google试试应该能直接打开了。
这时浏览器登录http://ip138.com/就会显示Shadowsocks服务器的IP啦！
测试完毕，按Ctrl + C关闭Shadowsocks。</p>

<h4>配置Systemd管理Shadowsocks</h4>

<p>新建Shadowsocks管理文件</p>

<pre><code>sudo nano /etc/systemd/system/shadowsocks-server.service
</code></pre>

<p>复制粘贴：</p>

<pre><code>[Unit]
Description=Shadowsocks Server
After=network.target

[Service]
ExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks/config.json
Restart=on-abort

[Install]
WantedBy=multi-user.target
</code></pre>

<p>Ctrl + O保存文件，Ctrl + X退出。
启动Shadowsocks：</p>

<pre><code>sudo systemctl start shadowsocks-server
</code></pre>

<p>设置开机启动Shadowsocks：</p>

<pre><code>sudo systemctl enable shadowsocks-server
</code></pre>

<p>至此，Shadowsock服务器端的基本配置已经全部完成了！</p>

<h4>优化</h4>

<p>这部分属于进阶操作，在你使用Shadowsocks时感觉到延迟较大，或吞吐量较低时，可以考虑对服务器端进行优化。</p>

<h5>开启BBR</h5>

<p>BBR系Google最新开发的TCP拥塞控制算法，目前有着较好的带宽提升效果，甚至不比老牌的锐速差。</p>

<h5>升级Linux内核</h5>

<p>BBR在Linux kernel 4.9引入。首先检查服务器kernel版本：</p>

<pre><code>uname -r
</code></pre>

<p>如果其显示版本在4.9.0之下，则需要升级Linux内核，否则请忽略下文。
更新包管理器：</p>

<pre><code>sudo apt update
</code></pre>

<p>查看可用的Linux内核版本：</p>

<pre><code>sudo apt-cache showpkg linux-image
</code></pre>

<p>找到一个你想要升级的Linux内核版本，如“linux-image-4.10.0-22-generic”：</p>

<pre><code>sudo apt install linux-image-4.10.0-22-generic
</code></pre>

<p>等待安装完成后重启服务器：</p>

<pre><code>sudo reboot
</code></pre>

<p>删除老的Linux内核：</p>

<pre><code>sudo purge-old-kernels
</code></pre>

<h4>开启BBR</h4>

<p>运行lsmod | grep bbr，如果结果中没有tcp_bbr，则先运行：</p>

<pre><code>modprobe tcp_bbr
echo "tcp_bbr" &gt;&gt; /etc/modules-load.d/modules.conf
</code></pre>

<p>运行：</p>

<pre><code>echo "net.core.default_qdisc=fq" &gt;&gt; /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" &gt;&gt; /etc/sysctl.conf
</code></pre>

<p>运行：</p>

<pre><code>sysctl -p
</code></pre>

<p>保存生效。运行：</p>

<pre><code>sysctl net.ipv4.tcp_available_congestion_control
sysctl net.ipv4.tcp_congestion_control
</code></pre>

<p>若均有bbr，则开启BBR成功。</p>

<h5>优化吞吐量</h5>

<p>新建配置文件：</p>

<pre><code>sudo nano /etc/sysctl.d/local.conf
</code></pre>

<p>复制粘贴：</p>

<pre><code># max open files
fs.file-max = 51200
# max read buffer
net.core.rmem_max = 67108864
# max write buffer
net.core.wmem_max = 67108864
# default read buffer
net.core.rmem_default = 65536
# default write buffer
net.core.wmem_default = 65536
# max processor input queue
net.core.netdev_max_backlog = 4096
# max backlog
net.core.somaxconn = 4096

# resist SYN flood attacks
net.ipv4.tcp_syncookies = 1
# reuse timewait sockets when safe
net.ipv4.tcp_tw_reuse = 1
# turn off fast timewait sockets recycling
net.ipv4.tcp_tw_recycle = 0
# short FIN timeout
net.ipv4.tcp_fin_timeout = 30
# short keepalive time
net.ipv4.tcp_keepalive_time = 1200
# outbound port range
net.ipv4.ip_local_port_range = 10000 65000
# max SYN backlog
net.ipv4.tcp_max_syn_backlog = 4096
# max timewait sockets held by system simultaneously
net.ipv4.tcp_max_tw_buckets = 5000
# turn on TCP Fast Open on both client and server side
net.ipv4.tcp_fastopen = 3
# TCP receive buffer
net.ipv4.tcp_rmem = 4096 87380 67108864
# TCP write buffer
net.ipv4.tcp_wmem = 4096 65536 67108864
# turn on path MTU discovery
net.ipv4.tcp_mtu_probing = 1

net.ipv4.tcp_congestion_control = bbr
</code></pre>

<p>运行：</p>

<pre><code>sysctl --system
</code></pre>

<p>编辑之前的shadowsocks-server.service文件：</p>

<pre><code>sudo nano /etc/systemd/system/shadowsocks-server.service
</code></pre>

<p>在ExecStart前插入一行，内容为：</p>

<pre><code>ExecStartPre=/bin/sh -c 'ulimit -n 51200'
</code></pre>

<p>即修改后的shadowsocks-server.service内容为：</p>

<pre><code>[Unit]
Description=Shadowsocks Server
After=network.target

[Service]
ExecStartPre=/bin/sh -c 'ulimit -n 51200'
ExecStart=/usr/local/bin/ssserver -c /etc/shadowsocks/config.json
Restart=on-abort

[Install]
WantedBy=multi-user.target
</code></pre>

<p>Ctrl + O保存文件，Ctrl + X退出。
重载shadowsocks-server.service：</p>

<pre><code>sudo systemctl daemon-reload
</code></pre>

<p>重启Shadowsocks：</p>

<pre><code>sudo systemctl restart shadowsocks-server
</code></pre>

<h5>开启TCP Fast Open</h5>

<p>TCP Fast Open可以降低Shadowsocks服务器和客户端的延迟。实际上在上一步已经开启了TCP Fast Open，现在只需要在Shadowsocks配置中启用TCP Fast Open。
编辑config.json：</p>

<pre><code>sudo nano /etc/shadowsocks/config.json
</code></pre>

<p>将fast_open的值由false修改为true。Ctrl + O保存文件，Ctrl + X退出。
重启Shadowsocks：</p>

<pre><code>sudo systemctl restart shadowsocks-server
</code></pre>

<p>注意：TCP Fast Open同时需要客户端的支持，即客户端Linux内核版本为3.7.1及以上；你可以在Shadowsocks客户端中启用TCP Fast Open。
至此，Shadowsock服务器端的优化已经全部完成了！</p>

            </section>

            <section class="meta">
                <span class="author">
                    <a href="http://oyty.me">oyty</a>
                </span>
                <span class="time">
                    /<time datetime="2018-06-14">2018-06-14</time>
                </span>
                <br/>
                <span class="license">
                    Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
                </span>
                <span class="categories">
                    in categories
                    <a href="http://oyty.me/category.html#其它" title="其它">其它</a>&nbsp;
                </span>
                <span class="tags">
                    tagged with
                    
                        <a href="http://oyty.me/tags.html# 翻墙" title=" 翻墙"> 翻墙</a>&nbsp;
                    
                        <a href="http://oyty.me/tags.html# shadowsocks" title=" shadowsocks"> shadowsocks</a>&nbsp;
                    
                        <a href="http://oyty.me/tags.html# bbr
" title=" bbr
"> bbr
</a>&nbsp;
                    
                </span>
            </section>

        </article>

    </div>
    <div id="disqus_thread"></div>
</div>

<script>

    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
     var disqus_config = function () {
     this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
     this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
     };
     */
    (function () { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://oyty-1.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
    Disqus.</a></noscript>



<script type="text/javascript">
    $(function () {

        /* set variables locally for increased performance */
        var scroll_timer;
        var displayed = false;
        var $message = $('#message a');
        var $window = $(window);
        var top = $(document.body).children(0).position().top;

        /* react to scroll event on window */
        $window.scroll(function () {
            window.clearTimeout(scroll_timer);
            scroll_timer = window.setTimeout(function () {
                if ($window.scrollTop() <= top + 800) {
                    displayed = false;
                    $message.fadeOut(1000);
                }
                else if (displayed == false) {
                    displayed = true;
                    $message.stop(true, true).show().click(function () {
                        $message.fadeOut(1000);
                    });
                }
            }, 100);
        });
    });
</script>
</body>

<script src="http://oyty.me/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115892756-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-115892756-1');
</script>

</html>